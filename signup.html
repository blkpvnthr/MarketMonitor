<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuantumQuant • Create Account</title>
  <link rel="icon" href="../static/favicon.ico" />

  <style>
    :root{
      --bg:#fff; --text:#0b0f17; --muted:rgba(11,15,23,.62);
      --line:rgba(0,0,0,.12); --panel:rgba(0,0,0,.03);
      --shadow:0 14px 40px rgba(0,0,0,.10); --radius:16px;
      --accent:#2563eb; --good:#16a34a; --warn:#d97706; --bad:#dc2626;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New";
      font-synthesis-weight:none;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: 'Roboto', ui-sans-serif, system-ui, -apple-system, Segoe UI, Helvetica, Arial;
      color:var(--text);
      background:var(--bg);
      min-height:100vh;
    }
    a{ color:#0b0f17 !important; text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* ===== Glass Navbar ===== */
    .navbar{
      position:sticky; top:0; z-index:50;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.85);
      backdrop-filter:blur(10px);
    }
    .navwrap{
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 10px 16px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      column-gap: 18px;
    }
    .navTitle{
      display:inline-flex;
      align-items:baseline;
      gap:8px;
      white-space:nowrap;
    }
    .navLinks{
      display:flex;
      justify-content:center;
      gap:18px;
      overflow:visible;
      min-width:0;
      align-items:center;
    }
    .navLinks a{ white-space:nowrap; padding:6px 10px; border-radius:10px; }
    .navRight{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:12px;
      min-width:0;
    }
    .navSearch{ width: min(420px, 34vw); min-width: 260px; }

    .pill{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:rgba(11,15,23,.72);
      white-space:nowrap;
    }

    /* Active nav (optional) */
    .navLinks a.active{
      background: rgba(37,99,235,.10);
      border: 1px solid rgba(37,99,235,.35);
      box-shadow: 0 4px 14px rgba(37,99,235,.18);
    }

    /* Buttons */
    button{
      cursor:pointer;
      border: 1px solid rgba(0,0,0,.14);
      background: rgba(0,0,0,.03);
      color: var(--text);
      padding: 11px 12px;
      border-radius: 14px;
      font-weight: 650;
      letter-spacing:.2px;
      transition: .15s ease;
    }
    button:hover{ transform: translateY(-1px); background: rgba(0,0,0,.05); }
    button:active{ transform: translateY(0px); }
    .primary{
      border-color: rgba(37,99,235,.35);
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(99,102,241,.08));
    }
    .danger{
      border-color: rgba(220,38,38,.35);
      background: rgba(220,38,38,.08);
    }

    /* Page layout */
    .page{
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 18px 42px;
    }
    .hero{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin: 10px 0 14px;
    }
    .brand{
      display:flex;flex-direction:column;gap:6px;
    }
    .brand h1{
      margin:0;
      font-size:26px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width: 36px;height: 36px;border-radius: 12px;
      background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(99,102,241,.9));
      box-shadow: 0 10px 22px rgba(37,99,235,.18);
      display:inline-flex;align-items:center;justify-content:center;
      font-weight: 900;color:#fff;
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      max-width: 720px;
    }

    .grid{
      display:grid;
      grid-template-columns: 480px 1fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .navSearch{ display:none; }
    }

    .card{
      background: rgba(255,255,255,.95);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.03), transparent);
    }
    .hd h2{ margin:0; font-size:14px; letter-spacing:.3px; color: rgba(11,15,23,.92); }
    .bd{ padding: 16px; }

    .field{ margin-bottom: 12px; }
    label{display:block;font-size:12px;color:rgba(11,15,23,.70);margin:0 0 6px 2px}
    input, select{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.98);
      color: var(--text);
      outline: none;
      transition: .15s ease;
    }
    input::placeholder{ color: rgba(11,15,23,.45); }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row > * { flex: 1; }
    .row.tight > * { flex: 0 0 auto; }

    .checkbox{
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      cursor:pointer;
      font-size: 12px;
      color: rgba(11,15,23,.72);
    }
    .checkbox input{ width:auto; margin:0; accent-color: var(--accent); }

    .btnbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    .msg{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.02);
      font-size: 13px;
      color: rgba(11,15,23,.82);
      display:none;
    }
    .msg.ok{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.08); }
    .msg.err{ border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.08); }

    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.03);
    }

    .sideList{ display:flex; flex-direction:column; gap:10px; }
    .sideItem{
      border:1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.02);
      border-radius: 14px;
      padding: 12px;
    }
    .sideItem strong{ display:block; margin-bottom:4px; }
    .sideItem small{ color: var(--muted); line-height:1.35; }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar" role="navigation" aria-label="Primary">
    <div class="navwrap">
      <div class="navLeft">
        <a href="/" style="text-decoration:none;color:inherit;">
          <div class="navTitle">
            <strong>Quantum<span style="font-weight: 100 !important;">Quant</span></strong>
          </div>
        </a>
      </div>

      <div class="navLinks" aria-label="Quick links">
        <a href="/index.html"><span>Dashboard</span></a>
        <a href="/brokers.html">Brokers</a>
        <a href="/script.html">Strategy</a>
        <a href="/backtests.html">Backtests</a>
      </div>

      <div class="navRight">
        <input class="navSearch" id="nav-search" type="text" placeholder="Filter feed (e.g. quote, trade)" />
        <span class="pill" id="nav-clock">--:--</span>
      </div>
    </div>
  </nav>

  <!-- Page -->
  <main class="page">
    <div class="hero">
      <div class="brand">
        <h1><span class="logo">Q</span> Create account</h1>
        <p class="subtitle">
          Create a QuantumQuant account to manage strategies, run backtests, and stream live market data.
        </p>
      </div>
      <div class="pill" id="envPill">Environment: <strong id="envName">Local</strong></div>
    </div>

    <div class="grid">
      <!-- Signup card -->
      <section class="card" aria-label="Signup form">
        <div class="hd">
          <h2>Sign up</h2>
          <span class="pill" id="authPill">Status: <strong id="authStatus">Signed out</strong></span>
        </div>
        <div class="bd">
          <form id="signupForm" autocomplete="on" novalidate>
            <div class="row">
              <div class="field" style="flex:1;">
                <label for="firstName">First name</label>
                <input id="firstName" name="firstName" type="text" placeholder="First Name" autocomplete="given-name" required />
              </div>
              <div class="field" style="flex:1;">
                <label for="lastName">Last name</label>
                <input id="lastName" name="lastName" type="text" placeholder="Last Name" autocomplete="family-name" required />
              </div>
            </div>

            <div class="field">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" placeholder="you@domain.com" autocomplete="email" required />
            </div>

            <div class="field">
              <label for="password">Password</label>
              <input id="password" name="password" type="password" placeholder="••••••••" autocomplete="new-password" required />
            </div>

            <div class="field">
              <label for="confirm">Confirm password</label>
              <input id="confirm" name="confirm" type="password" placeholder="••••••••" autocomplete="new-password" required />
            </div>

            <div class="field">
              <label for="plan">Plan</label>
              <select id="plan" name="plan">
                <option value="free" selected>Free</option>
                <option value="pro">Pro</option>
                <option value="team">Team</option>
              </select>
            </div>

            <div class="row tight" style="justify-content:space-between; margin-top: 6px;">
              <label class="checkbox">
                <input id="tos" type="checkbox" />
                I agree to the Terms & Privacy
              </label>
              <a href="/login.html" style="font-size:12px;color:rgba(11,15,23,.72)!important">Already have an account?</a>
            </div>

            <div class="btnbar">
              <button class="primary" type="submit" id="btnSignup">Create account</button>
              <button type="button" id="btnFillDemo">Fill demo</button>
              <button class="danger" type="button" id="btnClear">Clear</button>
            </div>

            <div class="msg" id="msgBox" role="status" aria-live="polite"></div>
          </form>
        </div>
      </section>

      <!-- Side info -->
      <aside class="card" aria-label="Signup info">
        <div class="hd">
          <h2>What happens next</h2>
          <span class="pill">Notes</span>
        </div>
        <div class="bd">
          <div class="sideList">
            <div class="sideItem">
              <strong>Endpoint</strong>
              <small>
                This form posts to <span class="kbd" id="signupEndpointKbd">/api/signup</span>.
                Wire that route on your backend to create users and return a token.
              </small>
            </div>
            <div class="sideItem">
              <strong>After signup</strong>
              <small>
                On success, we store <span class="kbd">qq_token</span> and redirect to <span class="kbd">/index.html</span>.
              </small>
            </div>
            <div class="sideItem">
              <strong>Password requirements</strong>
              <small>
                By default: 8+ chars. Add stronger rules server-side (recommended).
              </small>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>

<script>
  // ========= Config =========
  const API_ORIGIN =
    (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://127.0.0.1:8000"   // FastAPI dev server
      : "";                      // same-origin in prod

  const SIGNUP_ENDPOINT = `${API_ORIGIN}/api/signup`;
  const REDIRECT_TO = "/index.html";


  // ========= Navbar clock =========
  function tickClock(){
    const d = new Date();
    const s = d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    const el = document.getElementById("nav-clock");
    if (el) el.textContent = s;
  }
  tickClock();
  setInterval(tickClock, 1000 * 15);

  // ========= User dropdown (optional; safe if elements exist) =========
  (function initDropdown(){
    const userBtn = document.getElementById("userBtn");
    const userDropdown = document.getElementById("userDropdown");
    if (!userBtn || !userDropdown) return;

    function setDropdown(open){
      userDropdown.style.display = open ? "block" : "none";
      userBtn.setAttribute("aria-expanded", open ? "true" : "false");
    }
    userBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isOpen = userDropdown.style.display === "block";
      setDropdown(!isOpen);
    });
    document.addEventListener("click", () => setDropdown(false));
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setDropdown(false);
    });
  })();

  // ========= Auth helpers =========
  function getStore(){
    // use your "remember me" checkbox if present; otherwise default persistent
    const remember = document.getElementById("remember");
    return (remember && remember.checked) ? localStorage : sessionStorage;
  }

  function setSession({ token, user }){
    const store = getStore();
    store.setItem("qq_token", token);
    if (user) store.setItem("qq_user", JSON.stringify(user));

    // prevent stale token in the other store
    (store === localStorage ? sessionStorage : localStorage).removeItem("qq_token");
    (store === localStorage ? sessionStorage : localStorage).removeItem("qq_user");

    // update avatar if present
    const initials = user?.initials;
    const avatar = document.getElementById("userAvatar");
    if (avatar && initials) avatar.textContent = String(initials).toUpperCase();
  }

  function getToken(){
    return localStorage.getItem("qq_token") || sessionStorage.getItem("qq_token");
  }

  function setAuthUI(isAuthed){
    const authStatus = document.getElementById("authStatus");
    const loginLink = document.getElementById("loginLink");
    const logoutLink = document.getElementById("logoutLink");

    if (authStatus) authStatus.textContent = isAuthed ? "Signed in" : "Signed out";
    if (loginLink) loginLink.style.display = isAuthed ? "none" : "block";
    if (logoutLink) logoutLink.style.display = isAuthed ? "block" : "none";
  }

  function clearSession(){
    localStorage.removeItem("qq_token");
    localStorage.removeItem("qq_user");
    sessionStorage.removeItem("qq_token");
    sessionStorage.removeItem("qq_user");
    setAuthUI(false);
  }

  // ========= Message box =========
  const msgBox = document.getElementById("msgBox");
  function showMsg(text, kind){
    if (!msgBox) return;
    msgBox.textContent = text;
    msgBox.classList.remove("ok","err");
    if (kind) msgBox.classList.add(kind);
    msgBox.style.display = "block";
  }
  function hideMsg(){
    if (!msgBox) return;
    msgBox.style.display = "none";
    msgBox.textContent = "";
    msgBox.classList.remove("ok","err");
  }

  // ========= Validation helpers =========
  function passwordStrength(pw){
    if (!pw || pw.length < 8) return { ok:false, msg:"Password must be at least 8 characters." };
    if (pw.length > 128) return { ok:false, msg:"Password is too long (max 128 characters)." };
    const hasLetter = /[A-Za-z]/.test(pw);
    const hasNumber = /[0-9]/.test(pw);
    if (!hasLetter || !hasNumber) return { ok:false, msg:"Password should include letters and numbers." };
    return { ok:true };
  }

  // ========= Form logic =========
  const form = document.getElementById("signupForm");
  const btnFillDemo = document.getElementById("btnFillDemo");
  const btnClear = document.getElementById("btnClear");

  btnFillDemo?.addEventListener("click", () => {
    document.getElementById("firstName").value = "Demo";
    document.getElementById("lastName").value = "User";
    document.getElementById("email").value = `demo+${Date.now()}@quantumquant.local`;
    document.getElementById("password").value = "demo12345";
    document.getElementById("confirm").value = "demo12345";
    document.getElementById("plan").value = "free";
    document.getElementById("tos").checked = true;

    // if you have remember checkbox on signup, default it on
    const remember = document.getElementById("remember");
    if (remember) remember.checked = true;

    hideMsg();
    document.getElementById("firstName").focus();
  });

  btnClear?.addEventListener("click", () => {
    document.getElementById("firstName").value = "";
    document.getElementById("lastName").value = "";
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";
    document.getElementById("confirm").value = "";
    document.getElementById("plan").value = "free";
    document.getElementById("tos").checked = false;

    const remember = document.getElementById("remember");
    if (remember) remember.checked = false;

    hideMsg();
    document.getElementById("firstName").focus();
  });

  // Logout link (client-side only)
  document.getElementById("logoutLink")?.addEventListener("click", (e) => {
    e.preventDefault();
    clearSession();
    showMsg("Signed out.", "ok");
  });

  // ========= Submit =========
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    hideMsg();

    const firstName = (document.getElementById("firstName").value || "").trim();
    const lastName  = (document.getElementById("lastName").value || "").trim();
    const email     = (document.getElementById("email").value || "").trim();
    const password  = document.getElementById("password").value || "";
    const confirm   = document.getElementById("confirm").value || "";
    const plan      = document.getElementById("plan").value || "free";
    const tos       = !!document.getElementById("tos").checked;

    if (!firstName || !lastName || !email || !password || !confirm){
      showMsg("Please fill in all required fields.", "err");
      return;
    }
    if (!tos){
      showMsg("Please agree to the Terms & Privacy to continue.", "err");
      return;
    }
    if (password !== confirm){
      showMsg("Passwords do not match.", "err");
      return;
    }
    const st = passwordStrength(password);
    if (!st.ok){
      showMsg(st.msg, "err");
      return;
    }

    // disable submit while running (prevents double submit)
    const submitBtn = document.getElementById("btnSignup") || form.querySelector('button[type="submit"]');
    if (submitBtn) submitBtn.disabled = true;

    try{
      const res = await fetch(SIGNUP_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ firstName, lastName, email, password, plan }),
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok){
        // FastAPI uses {detail: "..."} by default
        const msg = data?.detail || data?.error || data?.message || `Signup failed (${res.status}).`;
        showMsg(msg, "err");
        return;
      }

      const token = data?.token;
      if (!token){
        showMsg("Signup succeeded but no token was returned by the server.", "err");
        return;
      }

      setSession({ token, user: data.user });
      setAuthUI(true);
      showMsg("Account created. Redirecting…", "ok");
      setTimeout(() => { window.location.href = REDIRECT_TO; }, 450);
    }catch(err){
      showMsg(
        "Could not reach the signup endpoint. Make sure the API is running on http://127.0.0.1:8000 and SIGNUP_ENDPOINT is correct.",
        "err"
      );
    }finally{
      if (submitBtn) submitBtn.disabled = false;
    }
  });

  // ========= Init =========
  const ep = document.getElementById("signupEndpointKbd");
  if (ep) ep.textContent = SIGNUP_ENDPOINT;

  const host = window.location.hostname || "local";
  const envName = document.getElementById("envName");
  if (envName){
    envName.textContent = (host.includes("localhost") || host.includes("127.0.0.1")) ? "Local" : host;
  }

  // If already authed, bounce
  const token = getToken();
  setAuthUI(!!token);
  if (token){
    showMsg("You’re already signed in. Redirecting…", "ok");
    setTimeout(() => { window.location.href = REDIRECT_TO; }, 350);
  }
</script>

</body>
</html>
